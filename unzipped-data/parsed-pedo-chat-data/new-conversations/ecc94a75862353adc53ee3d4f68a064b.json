{
    "id": "ecc94a75862353adc53ee3d4f68a064b",
    "messages": [
        "05d47a27f3c818abbf125051a57b268c (19:54): vice-versa:  you here??",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:06): how do I configure ftp transfers to go through iptables rules, I know how to configure iptables, but the ftp data transfer uses a high port on the server and a high port on the client, random!",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:06): should I open all high ports on the server? this would be sloppy...",
        "5f05b3ded4139f6a691da91429a957b9 (20:15): fluxdude: modprobe ip_conntrack_ftp",
        "5f05b3ded4139f6a691da91429a957b9 (20:18): or ip_nat_ftp (if it's doing forwarding to some other box inside the lan)",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:24): robw810: still not working, iptables has a rule to allow dport 21 and that is now modprobed",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:24): ip_conntrack_ftp I mean",
        "5f05b3ded4139f6a691da91429a957b9 (20:25): Is the firewall and ftp server the same box?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:25): ok sorry it works, I didn't enter the modprobe",
        "5f05b3ded4139f6a691da91429a957b9 (20:25): k :)",
        "842c224c189130c3429ed776e02bae7d (20:27): what you guys think about that problem:",
        "842c224c189130c3429ed776e02bae7d (20:27): machine A sends a SYN",
        "842c224c189130c3429ed776e02bae7d (20:27): machine B answers SYN/ACK",
        "842c224c189130c3429ed776e02bae7d (20:27): machine A does nothing now",
        "5f05b3ded4139f6a691da91429a957b9 (20:28): Is machine B actually receiving the SYN/ACK packet?",
        "5f05b3ded4139f6a691da91429a957b9 (20:29): s/B/A",
        "842c224c189130c3429ed776e02bae7d (20:30): any pcap software sees it",
        "842c224c189130c3429ed776e02bae7d (20:30): checksums are corrects",
        "5f05b3ded4139f6a691da91429a957b9 (20:31): Odd.  Bug in the userspace app?",
        "842c224c189130c3429ed776e02bae7d (20:31): there is a detail : machine A receive/send packets through a tun/tap at layer2 interface",
        "842c224c189130c3429ed776e02bae7d (20:31): robw810: any userspace app",
        "842c224c189130c3429ed776e02bae7d (20:31): there's a problem elsewhere",
        "5f05b3ded4139f6a691da91429a957b9 (20:33): Hmmm... have you tried adding a LOG rule on INPUT of box A (just to verify that all the other packet info looks right)?  I know this is basic, but that's all I know to check... :/",
        "842c224c189130c3429ed776e02bae7d (20:34): what the problem might be is that I got a DROP policy on that tuntap inteface",
        "842c224c189130c3429ed776e02bae7d (20:34): and a -m state ESTABLISHED,RELATED -j ACCEPT rule",
        "842c224c189130c3429ed776e02bae7d (20:35): but maybe the packets are not seen as established",
        "842c224c189130c3429ed776e02bae7d (20:35): I gotta check iptable's counter when I'll be @ home",
        "842c224c189130c3429ed776e02bae7d (20:36): I don't know very well how netfilter interacts with tun/tap intefaces",
        "5f05b3ded4139f6a691da91429a957b9 (20:36): Well, that's just it - they should be, assuming all the other packet info is correct;  this might be worth sending to the netfiler users and/or devel list",
        "842c224c189130c3429ed776e02bae7d (20:37): they should, but the underlayer context is a bit specific though",
        "842c224c189130c3429ed776e02bae7d (20:38): the tun/tap interface is feed by an monitoring wifi inteface and some code to chop off wireless stuff",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:41): robw810: I don't get it I thought it worked initially but I still can't connect to the ftp server even with ip_conntrack_ftp and &quot;ACCEPT tcp  --  anywhere anywhere tcp dpt:ftp&quot; at the top of the INPUT chain...",
        "5f05b3ded4139f6a691da91429a957b9 (20:44): fluxdude: Is the ftp server running on the same box as the iptables rules you're applying?",
        "5f05b3ded4139f6a691da91429a957b9 (20:44): matth: no idea, man - you're a bit outside my comfort zone there...",
        "842c224c189130c3429ed776e02bae7d (20:45): robw810: np ;)",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:46): robw810: yes",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:47): i've tried adding the rules for port 20 both source and dest, but when I iptables -F then connect, netstat shows me that port 20 isn't in use...",
        "03697b3b534d19c3dd1c41c4d558cd0a (20:48): fluxdude: sorry.. but can u explain ur problem again... I missed it :(",
        "5f05b3ded4139f6a691da91429a957b9 (20:49): fluxdude: if you've got the ftp conntrack module loaded, then the only port you need to open is 21",
        "5f05b3ded4139f6a691da91429a957b9 (20:49): If those are done, then the problem isn't iptables related",
        "93dede99112199d049a1bc421e564cd4 (20:50): Johnny23|work: I am now, was doing the lunch thing, what's up?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (20:53): linux_manju: I've got an ftp server on a box with iptables, I've got a rule to allow dport 21 through on the input chain at the top. I've also modprobed ip_conntrack_ftp. However I can't get to the ftp server properly, but if I do iptables -F then ftp works so it's obviously an iptables thing.",
        "56c04e220c2b8158650e1b62cda36ab5 (20:55): Incompetent Operator error&quot;)",
        "03697b3b534d19c3dd1c41c4d558cd0a (20:55): fluxdude: Well sounds tricky... But try this.... and see if it works for ya..",
        "03697b3b534d19c3dd1c41c4d558cd0a (20:56): iptables -I INPUT -i$ipt -A INPUT -i eth0 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT",
        "03697b3b534d19c3dd1c41c4d558cd0a (20:56): $ipt -A INPUT -i eth0 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT",
        "03697b3b534d19c3dd1c41c4d558cd0a (20:56): sorry... replace... $ipt with iptables...",
        "03697b3b534d19c3dd1c41c4d558cd0a (20:57): I faced the same problem.. That did the trick",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:01): linux_manju: still doesn't work, I can see in netstat &quot;tcp 0 0 ftpserver:21  mydesktop:3374  ESTABLISHED 7846/vsftpd&quot; but I can't get a dir listing with iptables up",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:02): fluxdude: what exactly is the error message ur getting... ?",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:02): fluxdude: and is it an active FTP or passive FTP?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): passive ftp",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): &lt;linux_manju&gt; sorry... replace... $ipt with iptables...",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): [16:54] &lt;linux_manju&gt; I faced the same problem.. That did the trick",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): sorry, I meant to paste this:",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): Command:\tLIST",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): Error:\tTransfer channel can't be opened. Reason: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): Error:\tCould not retrieve directory listing",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:03): Command:\tTYPE A",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:04): passive ftp, perhaps active would be more successful?",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:04): hmmmm.. IS the default policy DROP in input?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:05): linux_manju: no accept , but it's a redhat box with a default deny at the end of the chain,",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:05): trying active mode, seems to work on and off..",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:06): well, i get an inital dir listing but can't get anywhere after that it just hangs...",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:06): fluxdude: Ok.. Shall we try zeroing the counters and retry the connection.. We will get to know where exactly ..",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:06): the packets are getting dropped",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:06): this all works fine when uptables is flushed..",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:07): type... iptables -Z INPUT",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:07): and try ur connection.. from ftp client...",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:07): then iptables -L INPUT -nv",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:07): check the packets and bytes in the first and second coloumn..",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:08): 15   671 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:21",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:09): but the default redhat chain which is at the end of the input chain also has a lot of packets, more so than this rule",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:09): 82  8628 RH-Firewall-1-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0",
        "93dede99112199d049a1bc421e564cd4 (21:09): you need ftp data port 20 open too for non-PASV transfers",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:09): Is it running any other services that FTP?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:10): this is a passive transfer by default but I've tried both without luck",
        "93dede99112199d049a1bc421e564cd4 (21:11): fluxdude: did you have port 20 open for the active, (non-passive), ftp test?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:12): linux_manju: only ssh is open and there is only rpc,portmap and cups listening according to netstat",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:12): but the only ports I've opened in iptables are 20-22",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:12): i'm doing this via ssh of course...",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:13): fluxdude: try..",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:13): tail -f /proc/net/ip_conntrack",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:14): and see if the FTP session is going through the RELATED and ESTABLISHED state",
        "93dede99112199d049a1bc421e564cd4 (21:36): fluxdude: any joy yet?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:40): none at all, the tail-f doesn't move when I retry the connection..",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:42): fluxdude: any rules in the output chain?",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:43): iptables -L OUTPUT -nv",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:43): none at all and the policy is to accept",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:44): what r the iptables modules loaded rightnow?",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:44): lsmod  | grep -i ipt",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:52): ipt_REJECT              8641  1",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:52): ipt_state               3265  2",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:52): ip_conntrack           53657  1 ipt_state",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:52): iptable_filter          4417  1",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:52): ip_tables              20289  3 ipt_REJECT,ipt_state,iptable_filter",
        "5f05b3ded4139f6a691da91429a957b9 (21:52): x6/c",
        "5f05b3ded4139f6a691da91429a957b9 (21:52): pfft",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:54): fluxdude: try.. modprobe ip_conntrack_ftp.ko",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:55): just noticed ip_conntrack_ftp wasn't in there, despite me modprobing it earlier, done it again and it seems fine now",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:55): as well as",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:55): modprobe ip_nat_ftp.ko",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:55): does /etc/init.d/iptables restart remove this? surely not.",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:55): I'm not using nat, this is a host not a router",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:56): fluxdude: as a rule of thumb.. The iptables initialization script.. should take care of...",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:56): it is the init script! reloading it removes the ftp mod, thought I was going mad there!",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:56): adding and removing needed modules...",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:57): I suggest better make ur own script.. rather than Redhat firewall.. Its good for a desktop PC not for a production server.",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:58): well.. Does the connection work.. when the modules are loaded?",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:59): yes, and i've found when it loads it, sysconfig/iptables-config specifies which mods to load, by default it had none, so I've added ip_contrack_ftp and all is well now",
        "273d72e2cfe8af3dcc6adc12ddeacefd (21:59): thanks a lot for the help, couldn't have done it without you :-)",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:59): fluxdude: noprobs..",
        "03697b3b534d19c3dd1c41c4d558cd0a (21:59): cheers"
    ],
    "person_ids": [
        "05d47a27f3c818abbf125051a57b268c",
        "273d72e2cfe8af3dcc6adc12ddeacefd",
        "5f05b3ded4139f6a691da91429a957b9",
        "842c224c189130c3429ed776e02bae7d",
        "03697b3b534d19c3dd1c41c4d558cd0a",
        "93dede99112199d049a1bc421e564cd4",
        "56c04e220c2b8158650e1b62cda36ab5"
    ]
}