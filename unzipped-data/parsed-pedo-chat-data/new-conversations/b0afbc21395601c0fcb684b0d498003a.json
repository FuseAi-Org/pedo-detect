{
    "id": "b0afbc21395601c0fcb684b0d498003a",
    "messages": [
        "f3ad9ed3b7e0acef49753f686b5f2332 (19:47): hey",
        "f3ad9ed3b7e0acef49753f686b5f2332 (19:49): i want to know how a NAT works in practice when it is routing connections, packets etc but i cant find the information any where",
        "673d7d497cb7c30e46ce951bc321aafd (19:52): in what level ?",
        "673d7d497cb7c30e46ce951bc321aafd (19:53): NAT itself just means that the sourceip is altered and returning traffic has its destiionip altered",
        "673d7d497cb7c30e46ce951bc321aafd (19:53): along to that you can have stateful inspection which will use statettables to find out if a returning traffic is valid or not",
        "f3ad9ed3b7e0acef49753f686b5f2332 (19:57): okay can you by &quot;open&quot; a connection to a host create a valid statetable entry for it?",
        "f3ad9ed3b7e0acef49753f686b5f2332 (19:59): by some sort og shady TCP handsacke and a 3th party to control it",
        "673d7d497cb7c30e46ce951bc321aafd (20:00): the statetable in iptables has ehh 4 states: NEW, ESTABLISHED, RELATED and INVALID",
        "673d7d497cb7c30e46ce951bc321aafd (20:00): a state a considered NEW when there is no previous entry for it in the statetable",
        "673d7d497cb7c30e46ce951bc321aafd (20:00): the stattable is basically looking at srcip + srcport + dstip + dstport",
        "673d7d497cb7c30e46ce951bc321aafd (20:01): so when someone on internal network sends a syn paket to external ip the statetable will consider this syn packet as NEW and store its src+srcport+dst+dstport in the table",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:02): and if the host wil send the same packet back",
        "673d7d497cb7c30e46ce951bc321aafd (20:02): when the external ip then replies with an syn+ack it will get a hit in the statetable and the packet will be considered ESTABLISHED",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:03): and you would have a direct connection with 2 NAT'd hosts?",
        "673d7d497cb7c30e46ce951bc321aafd (20:03): which if you allow established packets back in it will be allowed and then processed by the postrouting which will switch the destip ip which was your externalip into the internal ip of the server/client who established this connection from inside",
        "673d7d497cb7c30e46ce951bc321aafd (20:03): well if an external source sends a syn packet to your iptables box that packet will be considered &quot;NEW&quot; unless it already exists in the stattable",
        "673d7d497cb7c30e46ce951bc321aafd (20:04): and then you need a prerouting rule which will tell the routing engine what to do with this packet since it arrived on externalip port 80 (for example)",
        "673d7d497cb7c30e46ce951bc321aafd (20:04): you will then preroute port 80 packets to inside ip 192.168.0.101 (for example which is your webservers ip on the inside)",
        "673d7d497cb7c30e46ce951bc321aafd (20:04): along to that you need a rule in FORWARD table which will allow traffic to 192.168.0.101 port 80",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:05): thats port forwarding",
        "673d7d497cb7c30e46ce951bc321aafd (20:05): yup",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:05): i want something like getting 2 hosts that are behind a NAt",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:06): 's to have a direct connections",
        "673d7d497cb7c30e46ce951bc321aafd (20:06): usually you setup the rules so that all inside-&gt;out connections are allowed",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:06): out of the box",
        "673d7d497cb7c30e46ce951bc321aafd (20:06): while outside-&gt;in must pass portforwarding so correct destination on the inside will get the packets",
        "673d7d497cb7c30e46ce951bc321aafd (20:06): direct connections between each other ?",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:06): yes",
        "673d7d497cb7c30e46ce951bc321aafd (20:06): are they behind same nat ?",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:07): no",
        "673d7d497cb7c30e46ce951bc321aafd (20:07): so its   host1  &lt;-&gt; nat  &lt;-&gt; internet &lt;-&gt; nat &lt;-&gt; host2    ?",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:07): yep",
        "673d7d497cb7c30e46ce951bc321aafd (20:07): which ports are involved ?",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:07): nothing yet",
        "673d7d497cb7c30e46ce951bc321aafd (20:08): well",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:08): i just looking for a way to get 2 nat'd hosts get a direct connection",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:08): im*",
        "673d7d497cb7c30e46ce951bc321aafd (20:08): say nat1... you could setup a preroute entry that says if sourceip from nat2 and destport is port 80 then preroute to host1",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:08): with no access to the routers*",
        "673d7d497cb7c30e46ce951bc321aafd (20:08): along with a FORWARD rule that says if destiantion ip host1 where source ip is nat2 and destinionport is 80 ALLOW the packet",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:09): so i thought if a server coordinated a TCP handsacke",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:09): it would work",
        "673d7d497cb7c30e46ce951bc321aafd (20:10): well one of the sides needs to portforward the traffic",
        "673d7d497cb7c30e46ce951bc321aafd (20:10): or you need to route through a third host",
        "673d7d497cb7c30e46ce951bc321aafd (20:10): but that would decrease performance",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:11): why? if host1 sends a syn then host2 sends a syn+ack with the same values would'nt it work?",
        "673d7d497cb7c30e46ce951bc321aafd (20:12): well sequencenumbers are involved",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:12): yes",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:12): they wil be decided by the server",
        "673d7d497cb7c30e46ce951bc321aafd (20:12): and since you dont have control of the routers which performs the nat you wont be able to alter the sequence numbers",
        "673d7d497cb7c30e46ce951bc321aafd (20:12): the nating will create its own sequence numbers",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:12): :/",
        "673d7d497cb7c30e46ce951bc321aafd (20:12): if im not mistaken",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:13): so if the NAT doesnt create its own sequence numbers it would work?",
        "673d7d497cb7c30e46ce951bc321aafd (20:14): might work",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:14): or dident :/ my grammer sucks",
        "673d7d497cb7c30e46ce951bc321aafd (20:14): but how will you tell the other side which seq you just sent ?",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:14): with help of a 3th party",
        "673d7d497cb7c30e46ce951bc321aafd (20:14): you would still need a 3rd host in between",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:14): yes",
        "673d7d497cb7c30e46ce951bc321aafd (20:14): the problem is how to know the seq when nating",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:15): but you dont need to route everything trough it",
        "673d7d497cb7c30e46ce951bc321aafd (20:15): but assume that your nat wont change seq numbers",
        "673d7d497cb7c30e46ce951bc321aafd (20:15): (i doubt it but say it as an example)",
        "673d7d497cb7c30e46ce951bc321aafd (20:15): then you would need to send two syns",
        "673d7d497cb7c30e46ce951bc321aafd (20:16): like first a syn to 3rd host      host2 does the same.... then you send a syn to nat2 with same seq as to 3rd host",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:16): thats the least problem",
        "673d7d497cb7c30e46ce951bc321aafd (20:16): the problem is that nat2 wont have any entry for incoming syn",
        "673d7d497cb7c30e46ce951bc321aafd (20:16): because it will just drop that packet since its not valid",
        "673d7d497cb7c30e46ce951bc321aafd (20:17): the problem would be not only seq numbers but also to force the packets to use the sourceports of the nat box as you want",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:20): that can all be control by a server",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:20): the only problem as i see it is if the seq numbers are regenerated by the NAT",
        "673d7d497cb7c30e46ce951bc321aafd (20:21): well the nat will most likely choose its own sourceport to use",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:21): hmm",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:22): thats another problem",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:23): so it wont work but im not crasy :)",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:23): crazy*",
        "673d7d497cb7c30e46ce951bc321aafd (20:24): it might work",
        "673d7d497cb7c30e46ce951bc321aafd (20:24): but most likely not depending on the configuration of the natboxes",
        "673d7d497cb7c30e46ce951bc321aafd (20:24): i mean if they alter the sequence numbers, if they alter source ports etc...",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:25): yea",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:25): so it wil work on crappy routers :)",
        "673d7d497cb7c30e46ce951bc321aafd (20:27): <a href=\"http://www.uvnc.com/addons/nat2nat.html\">http://www.uvnc.com/addons/nat2nat.html</a>",
        "f3ad9ed3b7e0acef49753f686b5f2332 (20:29): hmmm",
        "cde4047e4a44ae988313e04312155217 (20:44): Hi guys, I'm trying to make my firewall forward all traffic from the outside to another outside host (ie from port 88 to www.yahoo.com:80 ) . How can I do that ?",
        "cde4047e4a44ae988313e04312155217 (20:44): and what is it called. I can't find doc on that subject ;)",
        "cde4047e4a44ae988313e04312155217 (20:51): If you answer that question I'm ready to translate for faq to portuguese ;)",
        "1bc40d16b395c5f1dbe1749996291422 (21:09): Hello, I'm getting a passive mode error while trying to ftp through Iptables. Anyone familiar with this ?",
        "36bba6f052f4e1ac6d2fb3d5c6b08f63 (21:15): ttyS1, what's the error text? what did google say?",
        "36bba6f052f4e1ac6d2fb3d5c6b08f63 (21:16): chandi, you don't really need iptables for that, netcat will happilly do that.",
        "1bc40d16b395c5f1dbe1749996291422 (21:17): kumasan, I'm trying to look for something in google but I see nothing yet. where do you want me to paste the error ?",
        "cde4047e4a44ae988313e04312155217 (21:17): kumasan ok..but I didn't want to run another daemon since it's on openwrt (router). Do you think it's possible with iptables ? I've tried the same syntax as a forward to an internal host but I haven't succeded ;)",
        "36bba6f052f4e1ac6d2fb3d5c6b08f63 (21:19): ttyS1, if it's one line, here's fine.",
        "36bba6f052f4e1ac6d2fb3d5c6b08f63 (21:19): chandi, certainly possible with iptables, you want to forward a specific port, to a specific destination, right?",
        "cde4047e4a44ae988313e04312155217 (21:21): kumasan right",
        "cde4047e4a44ae988313e04312155217 (21:21): kumasan ie : port 2525 to smtp.isp.net:25",
        "1bc40d16b395c5f1dbe1749996291422 (21:23): kumasan: this is what i get using Filezilla with passive mode unchecked   <a href=\"http://authors.aspalliance.com/aylar/ViewPasteCode.aspx?PasteCodeID=5892\">http://authors.aspalliance.com/aylar/ViewPasteCode.aspx?PasteCodeID=5892</a>",
        "1bc40d16b395c5f1dbe1749996291422 (21:26): kumasan: and this in Filezilla with passive mode enabled  <a href=\"http://authors.aspalliance.com/aylar/ViewPasteCode.aspx?PasteCodeID=5893\">http://authors.aspalliance.com/aylar/ViewPasteCode.aspx?PasteCodeID=5893</a>",
        "cde4047e4a44ae988313e04312155217 (21:36): kumasan still here ?",
        "07a1c5c33bae2deefcf379337fdeaa13 (21:40): Hi",
        "cde4047e4a44ae988313e04312155217 (21:40): hi",
        "07a1c5c33bae2deefcf379337fdeaa13 (21:41): I'm trying to mark all the traffic of a vpn (ipsec) in a server to be able to change its routes... This is how I set the marks: <a href=\"http://rafb.net/paste/results/Sl9CQy35.html\">http://rafb.net/paste/results/Sl9CQy35.html</a>  Does anyone have any idea of this?",
        "07a1c5c33bae2deefcf379337fdeaa13 (21:48): What's -m multiport",
        "43d2e4c8ebdceba76435c1f675f8d628 (21:48): so you can specify multiple ports in one rule",
        "07a1c5c33bae2deefcf379337fdeaa13 (21:49): Thanks trappist",
        "cde4047e4a44ae988313e04312155217 (21:50): trappist have you got an idea about that : I'm trying to use iptables to forward from WAN side port 2525 to an external ip like smtp.isp.com:25 ? :)",
        "43d2e4c8ebdceba76435c1f675f8d628 (21:52): chandi: you'll need one DNAT rule and one SNAT rule",
        "cde4047e4a44ae988313e04312155217 (21:54): trappist have you got an example ?",
        "cde4047e4a44ae988313e04312155217 (21:54): please",
        "43d2e4c8ebdceba76435c1f675f8d628 (21:56): chandi: the NAT link in the topic covers the problem pretty well, but you'll obviously need to DNAT 2525 traffic to smtp.isp.com:25, then you'll need to SNAT traffic *from* smtp.isp.com to your ip address, otherwise smtp.isp.com will reply directly to the requestor, who isn't expecting the reply to come from there.",
        "43d2e4c8ebdceba76435c1f675f8d628 (21:56): sorry, SNAT traffic from your box *to* smtp.isp.com to your ip address.",
        "36bba6f052f4e1ac6d2fb3d5c6b08f63 (21:56): ttyS1, does the problem go away when you try the ftp connection without the firewall?",
        "cde4047e4a44ae988313e04312155217 (21:57): trappist ok, thanks :)",
        "cde4047e4a44ae988313e04312155217 (22:02): trappist I don't get the last line you've said : 1 SNAT rule from my box to smtp.isp.com ?",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:08): chandi: you want traffic from smtp.isp.com to come back to your machine, instead of replying back to the requestor.  so, you want the forwarded traffic from your machine to go to smtp.isp.com with the source IP of your machine, not the requestor.  so you make a SNAT rule to do that.",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:10): ok fine.  iptables -t nat -A POSTROUTING -p tcp --dport 25 -d smtp.isp.com -j SNAT --to-source my.ip.add.ress",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:12): so each packet comes from the requestor to you, from you to smtp.isp.com because of the DNAT rule, then the reply goes from smtp.isp.com back to you (because of the SNAT rule), and through you back to the requestor thanks to connection tracking magic.",
        "cde4047e4a44ae988313e04312155217 (22:15): trappist ok.. get it :) thanks a lot",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:16): np",
        "cde4047e4a44ae988313e04312155217 (22:17): trappist it works fine. Thanks a LOT!!!",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:30): chandi: cool :)",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:30): I've never actually done it",
        "43d2e4c8ebdceba76435c1f675f8d628 (22:30): I thought, in theory it should work :)",
        "cde4047e4a44ae988313e04312155217 (22:30): haha",
        "93dede99112199d049a1bc421e564cd4 (22:34): chandi: I'm thinking of doing something similar, can you paste the two rules you used to accomplish this?",
        "93dede99112199d049a1bc421e564cd4 (22:48): chandi: or not.. :(",
        "93dede99112199d049a1bc421e564cd4 (22:56): nm, figured it out with a test case...seen what I was doing wrong"
    ],
    "person_ids": [
        "f3ad9ed3b7e0acef49753f686b5f2332",
        "673d7d497cb7c30e46ce951bc321aafd",
        "cde4047e4a44ae988313e04312155217",
        "1bc40d16b395c5f1dbe1749996291422",
        "36bba6f052f4e1ac6d2fb3d5c6b08f63",
        "07a1c5c33bae2deefcf379337fdeaa13",
        "43d2e4c8ebdceba76435c1f675f8d628",
        "93dede99112199d049a1bc421e564cd4"
    ]
}